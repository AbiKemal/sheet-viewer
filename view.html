google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(drawTable);

function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

function drawTable() {
  const nama = getQueryParam("nama");
  if (!nama) {
    document.getElementById("table_div").innerHTML = "Nama peserta tidak ditemukan di URL.";
    return;
  }

  // Update informasi di bagian atas
  document.getElementById("judul").innerHTML = `
    <div class="header">
      <h2>KARTU TABUNGAN QURBAN TAHUN 2026</h2>
      <p>Kp. Pasar Senen Desa Ciasihan Kec. Pamijahan</p>
    </div>
    <div class="info-row">
      <div><strong>NAMA:</strong> ${nama}</div>
      <div class="info-right">
        <div><strong>Jumlah Dana Qurban</strong></div>
        <div><strong>RP 3.000.000</strong></div>
      </div>
    </div>
  `;

  // Ambil data dari Google Sheet
  var sheetId = '1aNWfGYIqARaSmDXl0eqJ5Sy6htOgBgMTIZC1SlZA0vA';
  var sheetName = 'DATABASE';
  var queryString = encodeURIComponent(`SELECT A, B, C, D, E, H WHERE B = '${nama}'`);
  var dataSourceUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&headers=1&tq=${queryString}`;

  var query = new google.visualization.Query(dataSourceUrl);
  query.send(function(response) {
    if (response.isError()) {
      document.getElementById("table_div").innerHTML = 'Gagal memuat data: ' + response.getMessage();
      return;
    }

    var data = response.getDataTable();
    var table = new google.visualization.Table(document.getElementById('table_div'));
    table.draw(data, {showRowNumber: true, width: '100%', height: 'auto'});

    // Menghitung total tabungan
    let totalTabungan = 0;
    for (let i = 0; i < data.getNumberOfRows(); i++) {
      totalTabungan += data.getValue(i, 3);  // Kolom D berisi jumlah tabungan
    }

    // Menambahkan total tabungan
    const totalTabunganDiv = document.createElement('div');
    totalTabunganDiv.innerHTML = `<strong>TOTAL TABUNGAN: </strong> Rp ${totalTabungan.toLocaleString()}`;
    document.getElementById("total_tabungan").appendChild(totalTabunganDiv);
  });
}
